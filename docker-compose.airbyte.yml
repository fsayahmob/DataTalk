version: "3.8"

services:
  # Airbyte Database (internal metadata)
  airbyte-db:
    image: postgres:13
    container_name: airbyte-db
    environment:
      - POSTGRES_USER=airbyte
      - POSTGRES_PASSWORD=airbyte
      - POSTGRES_DB=airbyte
    volumes:
      - airbyte-db-data:/var/lib/postgresql/data
    networks:
      - airbyte-network

  # Airbyte Server (API backend)
  airbyte-server:
    image: airbyte/server:latest
    container_name: airbyte-server
    ports:
      - "8001:8001"
    environment:
      - DATABASE_USER=airbyte
      - DATABASE_PASSWORD=airbyte
      - DATABASE_DB=airbyte
      - DATABASE_URL=jdbc:postgresql://airbyte-db:5432/airbyte
      - WORKSPACE_ROOT=/tmp/workspace
      - WORKSPACE_DOCKER_MOUNT=airbyte_workspace
      - LOCAL_ROOT=/tmp/airbyte_local
      - TRACKING_STRATEGY=logging
    volumes:
      - airbyte-workspace:/tmp/workspace
      - airbyte-local:/tmp/airbyte_local
      # Monter le dossier data pour accéder à g7_analytics.duckdb
      - ./data:/data
    depends_on:
      - airbyte-db
    networks:
      - airbyte-network

  # Airbyte Worker (exécute les syncs)
  airbyte-worker:
    image: airbyte/worker:latest
    container_name: airbyte-worker
    environment:
      - DATABASE_USER=airbyte
      - DATABASE_PASSWORD=airbyte
      - DATABASE_DB=airbyte
      - DATABASE_URL=jdbc:postgresql://airbyte-db:5432/airbyte
      - WORKSPACE_ROOT=/tmp/workspace
      - WORKSPACE_DOCKER_MOUNT=airbyte_workspace
      - LOCAL_ROOT=/tmp/airbyte_local
      - TRACKING_STRATEGY=logging
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - airbyte-workspace:/tmp/workspace
      - airbyte-local:/tmp/airbyte_local
      # Monter le dossier data pour accéder à g7_analytics.duckdb
      - ./data:/data
    depends_on:
      - airbyte-db
    networks:
      - airbyte-network

  # Airbyte Web UI
  airbyte-webapp:
    image: airbyte/webapp:latest
    container_name: airbyte-webapp
    ports:
      - "8000:80"
    environment:
      - AIRBYTE_API_URL=http://airbyte-server:8001/api/v1
    depends_on:
      - airbyte-server
    networks:
      - airbyte-network

  # Airbyte Temporal (workflow engine)
  airbyte-temporal:
    image: temporalio/auto-setup:latest
    container_name: airbyte-temporal
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=airbyte
      - POSTGRES_PWD=airbyte
      - POSTGRES_SEEDS=airbyte-db
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml
    volumes:
      - airbyte-temporal:/etc/temporal
    depends_on:
      - airbyte-db
    networks:
      - airbyte-network

volumes:
  airbyte-db-data:
  airbyte-workspace:
  airbyte-local:
  airbyte-temporal:

networks:
  airbyte-network:
    driver: bridge
